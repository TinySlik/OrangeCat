<!DOCTYPE html>
<html lang="en">
  <head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="jsoneditor.min.css">
    <link rel="stylesheet" type="text/css" href="json_editor.css">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jsoneditor.min.js"></script>
    <meta name="theme-color" content="#000000">
    <title>Parameter Server</title>
    <script src="./video.js"></script>
  </head>
  <body>
    

    <div class="content">
      <img src="cat.svg" style="float:right; height: 70px; border-radius: 2px;">
      <h1>Orange Cat Parameter Server</h1>
      <fieldset>
        <legend>Device settings</legend>
        <div>
          <button id="sync_btn" width=200>Sync Settings</button>
          <button id="save_btn" width=200>Save Settings</button>
        </div>
        <div id="jsoneditor" style="width: 830px; height: 500px;"></div>
        <script>
            setInterval(function() {
              $.ajax({
                url: '/get_dev_status',
                dataType: 'json',
                success: function(json) {
                  $('#dev_status').empty();
                  for (var key in json) {
                    var Div = document.createElement('div');
                    var str = "<label>" + key+':'+json[key] + "</label>";
                    Div.innerHTML = str;
                    $('#dev_status').append(Div);
                  }
                }
              });
            }, 1000);

            // create the editor
            const container = document.getElementById("jsoneditor")
            const options = {
              modes: ['form', 'tree', 'view', 'code', 'text'],
              name: "root",
              onChangeJSON: function(json) {
                // $.ajax({
                //   url: '/set_dev_ctrl',
                //   data: { code_res: encodeURIComponent(JSON.stringify(editor.get()))},
                //   dataType: 'json',
                //   success: function(json_in) {
                //       json_dev_ctrl = json_in;
                //   },
                //   complete: function(a, status) {
                //     console.log(status);
                //     if (status == "success") {
                //       // todo
                //     } else {
                //       editor.set(json_dev_ctrl);
                //     }
                //   }
                // });
              }
            }
            const editor = new JSONEditor(container, options)

            $.ajax({
              url: '/get_dev_ctrl',
              dataType: 'json',
                success: function(json_in) {
                    editor.set(json_in);
                }
            });

            $("#sync_btn").click(function(){
              $.ajax({
                url: '/get_dev_ctrl',
                dataType: 'json',
                  success: function(json_in) {
                      json_dev_ctrl = json_in;
                      editor.set(json_in);
                  }
              });
            })

            $("#save_btn").click(function(){
              $.ajax({
                url: '/set_dev_ctrl',
                data: { code_res: encodeURIComponent(JSON.stringify(editor.get()))},
                dataType: 'json',
                success: function(json_in) {
                    json_dev_ctrl = json_in;
                },
                complete: function(a, status) {
                  console.log(status);
                  if (status == "success") {
                    // todo
                  } else {
                    editor.set(json_dev_ctrl);
                  }
                }
              });
            })
        </script>
      </fieldset>
      <fieldset>
        <legend>Device status</legend>
          <div id="dev_status"></div>
      </fieldset>
      <fieldset>
        <legend>Cam Data</legend>
        
        <div>
          <button onclick="start()">开始</button>
        </div>
        <br>
        <div id="data_show">
         <img id="Camera" src=./cat.svg alt="图片Base64编码" style="max-width:90%; max-height:2000px;"/>
        
         <script type="module">
          import * as THREE from './three.module.js';
          let texture;
          let image = document.getElementById("Camera");
          // image.style.display = 'none';
          texture = new THREE.TextureLoader().load(document.getElementById("Camera").src);
          texture.needUpdate = true;
          // immediately use the texture for material creation
          let material = new THREE.MeshBasicMaterial( { map: texture } );
          material.needUpdate = true;
    
          let scene = new THREE.Scene();
          let camera = new THREE.PerspectiveCamera( 75, 
          830 / 500, 
          0.1, 1000 );
    
          const renderer = new THREE.WebGLRenderer();
          renderer.setSize( 830, 500 );
          document.getElementById("data_show").appendChild(renderer.domElement);
          const geometry = new THREE.BoxGeometry( 1, 1, 1 );
          // const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
          let cube = new THREE.Mesh( geometry, material );
          scene.add( cube );
    
          camera.position.z = 5;
    
          function animate() {
            texture = new THREE.TextureLoader().load(document.getElementById("Camera").src);
            material = new THREE.MeshBasicMaterial( { map: texture } );
            cube.MeshBasicMaterial = { map: texture };
            // material = new THREE.MeshBasicMaterial( { map: texture } );
            // cube = new THREE.Mesh( geometry, material );
            // scene.add( cube );
            // material.needUpdate = true;

            // texture = new THREE.TextureLoader().load(document.getElementById("Camera").src);
            // cube.MeshBasicMaterial = new THREE.MeshBasicMaterial( { map: texture } );
            requestAnimationFrame( animate );
    
            cube.rotation.x += 0.01;
            cube.rotation.y += 0.01;
            renderer.render( scene, camera );
          }
    
          animate();
        </script>
        </div>
      </fieldset>
    </div>
  </body></html>
