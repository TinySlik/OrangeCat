<!DOCTYPE html>
<html lang="en">
  <head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="jsoneditor.min.css">
    <link rel="stylesheet" type="text/css" href="json_editor.css">
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jsoneditor.min.js"></script>
    <meta name="theme-color" content="#000000">
    <title>Parameter Server</title>
    <script type="module">
      import * as THREE from './three.module.js';
      let camData = "./cat.svg";

      let texture = new THREE.TextureLoader().load(camData);
      // immediately use the texture for material creation
      let material = new THREE.MeshBasicMaterial( { map: texture } );

      let scene = new THREE.Scene();
      let camera = new THREE.PerspectiveCamera( 75, 
      830 / 500, 
      0.1, 1000 );

      const renderer = new THREE.WebGLRenderer();
      renderer.setSize( 830, 500 );
      document.getElementById("data_show").appendChild(renderer.domElement);
      const geometry = new THREE.BoxGeometry( 2.5, 2.5, 2.5 );
      // const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
      let cube = new THREE.Mesh( geometry, material );
      scene.add( cube );

      camera.position.z = 5;
      let tag = false;
      let image = document.getElementById("Camera");
      image.src = camData;
      image.style.display = 'none';
      image.addEventListener( 'load', function ( event ) {
        texture = new THREE.TextureLoader().load(camData, function(tex){
          material.map = tex;
          material.needsUpdate = true;
          renderer.render(scene, camera);
        });
      });

      $("#get_data").click(function(){
        connecteClient();
      })

      function connecteClient() {
        // 打开一个 web socket
        var ws = new WebSocket("ws://" + window.location.host);

        // 连接建立后的回调函数
        ws.onopen = function () {
          console.log("WebSocket 连接成功");
        };

        // 接收到服务器消息后的回调函数
        ws.onmessage = function (evt) {
          var received_msg = evt.data;
          blobToDataURI(received_msg, function (result) {
            camData = result;
            image.src = result;
          })
        };

        // 连接关闭后的回调函数
        ws.onclose = function () {
          // 关闭 websocket
          alert("连接已关闭..." + "ws://" + window.location.host);
        };
      }

      function blobToDataURI(blob, callback) {
        var reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onload = function (e) {
          callback(e.target.result.replace("data:application/octet-stream", "data:image/png"));
        }
      }

      function animate() {
        requestAnimationFrame( animate );
        cube.rotation.x += 0.01;
        cube.rotation.y += 0.01;
        renderer.render( scene, camera );
      }

      animate();
    </script>
  </head>
  <body>
    <div class="content">
      <img src="cat.svg" style="float:right; height: 70px; border-radius: 2px;">
      <h1>Orange Cat Parameter Server</h1>
      <fieldset>
        <legend>Device settings</legend>
        <div>
          <button id="sync_btn" width=200>Sync Settings</button>
          <button id="save_btn" width=200>Save Settings</button>
        </div>
        <div id="jsoneditor" style="width: 830px; height: 500px;"></div>
        <script>
            setInterval(function() {
              $.ajax({
                url: '/get_dev_status',
                dataType: 'json',
                success: function(json) {
                  $('#dev_status').empty();
                  for (var key in json) {
                    var Div = document.createElement('div');
                    var str = "<label>" + key+':'+json[key] + "</label>";
                    Div.innerHTML = str;
                    $('#dev_status').append(Div);
                  }
                }
              });
            }, 1000);

            // create the editor
            const container = document.getElementById("jsoneditor")
            const options = {
              modes: ['form', 'tree', 'view', 'code', 'text'],
              name: "root",
              onChangeJSON: function(json) {
                // $.ajax({
                //   url: '/set_dev_ctrl',
                //   data: { code_res: encodeURIComponent(JSON.stringify(editor.get()))},
                //   dataType: 'json',
                //   success: function(json_in) {
                //       json_dev_ctrl = json_in;
                //   },
                //   complete: function(a, status) {
                //     console.log(status);
                //     if (status == "success") {
                //       // todo
                //     } else {
                //       editor.set(json_dev_ctrl);
                //     }
                //   }
                // });
              }
            }
            const editor = new JSONEditor(container, options)

            $.ajax({
              url: '/get_dev_ctrl',
              dataType: 'json',
                success: function(json_in) {
                    editor.set(json_in);
                }
            });

            $("#sync_btn").click(function(){
              $.ajax({
                url: '/get_dev_ctrl',
                dataType: 'json',
                  success: function(json_in) {
                      json_dev_ctrl = json_in;
                      editor.set(json_in);
                  }
              });
            })

            $("#save_btn").click(function(){
              $.ajax({
                url: '/set_dev_ctrl',
                data: { code_res: encodeURIComponent(JSON.stringify(editor.get()))},
                dataType: 'json',
                success: function(json_in) {
                    json_dev_ctrl = json_in;
                },
                complete: function(a, status) {
                  console.log(status);
                  if (status == "success") {
                    // todo
                  } else {
                    editor.set(json_dev_ctrl);
                  }
                }
              });
            })
        </script>
      </fieldset>
      <fieldset>
        <legend>Cam Data</legend>
        <div>
          <button id="get_data">获取数据</button>
        </div>
        <br>
        <div id="data_show">
         <img id="Camera" alt="data" style="max-width:90%; max-height:2000px;"/>
        </div>
      </fieldset>
      <fieldset>
        <legend>Device status</legend>
          <div id="dev_status"></div>
      </fieldset>
    </div>
  </body></html>
